name: ü§ñ GitHub Copilot Coder (Master)

# This is a reusable workflow that can be called from other repositories.
# It contains the full implementation logic for the Copilot Coder.
#
# To use this workflow from another repository, create a caller workflow:
#   jobs:
#     copilot:
#       uses: <org>/GHES_CodingAgent/.github/workflows/copilot-coder-master.yml@main
#       secrets: inherit

on:
  # Direct trigger (for this repository)
  issues:
    types: [labeled]
  
  # Reusable workflow trigger (for other repositories)
  workflow_call:
    secrets:
      GH_TOKEN:
        description: 'Classic PAT with repo and workflow scopes'
        required: true
      COPILOT_TOKEN:
        description: 'Token for GitHub Copilot API access'
        required: true
      CONTEXT7_API_KEY:
        description: 'API key for Context7 documentation service'
        required: false

jobs:
  copilot-cli:
    # Only run when the issue has the 'copilot' label
    if: contains(github.event.issue.labels.*.name, 'copilot')
    runs-on: self-hosted
    
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    env:
      MODEL: claude-haiku-4.5
      COPILOT_VERSION: 0.0.352
      # Extract hostname from server URL (removes https:// prefix)
      GHES_HOSTNAME: ${{ github.server_url }}
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_BODY: ${{ github.event.issue.body }}
      ISSUE_ASSIGNEE: ${{ github.event.issue.assignee.login }}
      ISSUE_CREATOR: ${{ github.event.issue.user.login }}
      REPO_NAME: ${{ github.repository }}
      BRANCH_NAME: copilot/${{ github.event.issue.number }}
    
    steps:
      - name: üöÄ Start Workflow
        run: |
          echo "üöÄ GitHub Copilot Coder workflow started!"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìã Issue: #${ISSUE_NUMBER}"
          echo "üìå Title: ${ISSUE_TITLE}"
          echo "üë§ Creator: ${ISSUE_CREATOR}"
          echo "üì¶ Repository: ${REPO_NAME}"
          echo "üåø Branch: ${BRANCH_NAME}"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_CREATOR: ${{ github.event.issue.user.login }}
          REPO_NAME: ${{ github.repository }}
          BRANCH_NAME: copilot/${{ github.event.issue.number }}
      
      - name: üîê Configure Git Credentials for GHES
        run: |
          # Extract hostname from server URL (remove https:// prefix)
          GHES_HOST=$(echo "${{ github.server_url }}" | sed 's|https://||')
          echo "GHES_HOST=${GHES_HOST}" >> $GITHUB_ENV
          
          git config --global credential.helper store
          echo "https://x-access-token:${{ github.token }}@${GHES_HOST}" >> ~/.git-credentials
          chmod 600 ~/.git-credentials
          echo "‚úÖ Git credentials configured for GHES (${GHES_HOST})"
      
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          persist-credentials: true
      
      - name: üîê Configure GitHub CLI for GHES
        run: |
          # Configure gh to use GHES instance (GHES_HOST set in previous step)
          gh auth login --hostname "${GHES_HOST}" --with-token <<< "${{ secrets.GH_TOKEN }}"
          gh auth status --hostname "${GHES_HOST}"
          echo "‚úÖ GitHub CLI configured for GHES (${GHES_HOST})"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: üè∑Ô∏è Update Issue Labels - In Progress
        run: |
          gh issue edit ${{ env.ISSUE_NUMBER }} \
            --add-label "in-progress" \
            --remove-label "copilot"
          
          # Add comment to notify that Copilot is working on this issue
          COMMENT="## ü§ñ Copilot is on it!
          
          Copilot has been assigned to work on this issue. You can view progress under [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}), and once completed a PR will be linked here."
          
          gh issue comment "${{ env.ISSUE_NUMBER }}" --body "${COMMENT}"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: ‚úÖ Verify Pre-installed Software
        run: |
          echo "üîç Verifying pre-installed software..."
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          # Check Python
          if command -v python3 &> /dev/null; then
            PYTHON_VERSION=$(python3 --version)
            echo "‚úÖ Python: $PYTHON_VERSION"
          else
            echo "‚ùå ERROR: Python 3 is not installed!"
            echo "Please run scripts/setup-runner.sh on this runner."
            exit 1
          fi
          
          # Check uv
          if command -v uv &> /dev/null; then
            UV_VERSION=$(uv --version)
            echo "‚úÖ uv: $UV_VERSION"
          else
            echo "‚ùå ERROR: uv is not installed!"
            echo "Please run scripts/setup-runner.sh on this runner."
            exit 1
          fi
          
          # Check Node.js
          if command -v node &> /dev/null; then
            NODE_VERSION=$(node --version)
            NPM_VERSION=$(npm --version)
            echo "‚úÖ Node.js: $NODE_VERSION"
            echo "‚úÖ npm: $NPM_VERSION"
            
            # Verify Node.js major version is 22
            NODE_MAJOR=$(echo $NODE_VERSION | cut -d. -f1 | sed 's/v//')
            if [ "$NODE_MAJOR" != "22" ]; then
              echo "‚ö†Ô∏è  WARNING: Node.js 22.x is recommended, but $NODE_VERSION is installed."
            fi
          else
            echo "‚ùå ERROR: Node.js is not installed!"
            echo "Please run scripts/setup-runner.sh on this runner."
            exit 1
          fi
          
          # Check GitHub Copilot CLI
          if command -v copilot &> /dev/null; then
            COPILOT_VERSION_INSTALLED=$(copilot --version 2>&1 | head -n1)
            echo "‚úÖ Copilot CLI: $COPILOT_VERSION_INSTALLED"
          else
            echo "‚ùå ERROR: GitHub Copilot CLI is not installed!"
            echo "Please run scripts/setup-runner.sh on this runner."
            exit 1
          fi
          
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ All required software is installed and ready!"
      
      - name: ‚öôÔ∏è Configure MCP Servers
        run: |
          mkdir -p ~/.config
          
          # Fetch mcp-config.json from the central GHES_CodingAgent repository
          echo "üì• Fetching MCP configuration from GHES_CodingAgent..."
          GHES_HOST=$(echo "${{ github.server_url }}" | sed 's|https://||')
          OWNER="${{ github.repository_owner }}"
          
          # Determine API base URL
          if [[ "$GHES_HOST" == "github.com" ]]; then
              API_BASE="https://api.github.com"
          else
              API_BASE="https://$GHES_HOST/api/v3"
          fi
          
          # Download mcp-config.json from GHES_CodingAgent repo
          curl -s \
              -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
              -H "Accept: application/vnd.github.v3.raw" \
              "$API_BASE/repos/$OWNER/GHES_CodingAgent/contents/mcp-config.json" \
              > ~/.config/mcp-config.json
          
          if [ -s ~/.config/mcp-config.json ]; then
              echo "‚úÖ MCP configuration downloaded to ~/.config/mcp-config.json"
              cat ~/.config/mcp-config.json
          else
              echo "‚ùå Failed to download MCP configuration"
              exit 1
          fi
      
      - name: üß∞ Check MCP Access
        run: |
          echo "üß∞ Verifying MCP server access..."
          copilot -p "List tools defined in the current chat session (do not run commands, I am asking about tools defined in the LLM). Just the names in a table, nothing else." --allow-all-tools
        env:
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
      
      - name: üåø Create Feature Branch
        run: |
          echo "üåø Creating feature branch..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ env.BRANCH_NAME }}
          echo "‚úÖ Branch ${{ env.BRANCH_NAME }} created"
      
      - name: ü§ñ Implement Changes with Copilot
        timeout-minutes: 30
        working-directory: ${{ github.workspace }}
        run: |
          echo "ü§ñ Running GitHub Copilot CLI..."
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "üìã Issue: #${ISSUE_NUMBER}"
          echo "üìå Title: ${ISSUE_TITLE}"
          echo "üóÇÔ∏è  Working Directory: $(pwd)"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          echo "This is the description that Copilot CLI is going to use to implement the task:"
          echo "${ISSUE_BODY}"
          
          mkdir -p logs
          
          # Save issue body to file to avoid injection
          printf '%s' "${ISSUE_BODY}" > /tmp/issue_description.txt
          
          # Run Copilot with file input
          # Note: -p flag runs in non-interactive mode
          # --add-dir allows Copilot to access files in the workspace directory
          copilot -p "Implement the GitHub issue following the description details: $(cat /tmp/issue_description.txt)" \
            --add-dir "$(pwd)" \
            --allow-all-tools \
            --log-level all \
            --log-dir logs \
            --model "${MODEL}"
          
          # Clean up
          rm -f /tmp/issue_description.txt
          
          echo "‚úÖ Implementation completed"
        env:
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          MODEL: ${{ env.MODEL }}
      
      - name: üíæ Commit Changes
        run: |
          echo "üìù Preparing commit..."
          
          # Co-author info from issue creator
          CREATOR_NAME="${ISSUE_CREATOR}"
          CREATOR_EMAIL="${ISSUE_CREATOR}@users.noreply.github.com"
          echo "üë§ Co-author: ${CREATOR_NAME} <${CREATOR_EMAIL}>"
          
          # Add all files except metadata files
          git add .
          
          # Exclude metadata files from commit
          for file in copilot-summary.md commit-message.md .final-commit-msg.txt .github/copilot-instructions.md; do
            if git ls-files --cached "$file" > /dev/null 2>&1; then
              git reset HEAD "$file" 2>/dev/null || true
            fi
          done
          
          # Check if there are any staged changes
          if ! git diff --cached --quiet; then
            echo "‚úÖ Changes staged for commit"
          else
            echo "‚ö†Ô∏è  No changes staged for commit"
          fi
          
          # Prepare final commit message with co-author
          if [ -f "commit-message.md" ]; then
            echo "‚úÖ Using Copilot-generated commit message"
            {
              cat commit-message.md
              echo ""
              echo ""
              echo "Co-authored-by: ${CREATOR_NAME} <${CREATOR_EMAIL}>"
            } > .final-commit-msg.txt
          else
            echo "‚ö†Ô∏è  commit-message.md not found, using default message"
            {
              echo "feat: Implement issue ${ISSUE_NUMBER}"
              echo ""
              echo "${ISSUE_TITLE}"
              echo ""
              echo "Changes implemented by GitHub Copilot CLI"
              echo ""
              echo "Co-authored-by: ${CREATOR_NAME} <${CREATOR_EMAIL}>"
            } > .final-commit-msg.txt
          fi
          
          # Create commit if there are staged changes
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è  No staged changes to commit, skipping git commit"
          else
            git commit -F .final-commit-msg.txt
            echo "‚úÖ Changes committed successfully"
          fi
          
          # Clean up
          rm -f .final-commit-msg.txt
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_CREATOR: ${{ github.event.issue.user.login }}
      
      - name: üöÄ Push Branch
        run: |
          echo "üöÄ Pushing branch to remote..."
          
          # Configure git remote with GH_TOKEN for authentication
          REMOTE_URL=$(git remote get-url origin)
          if [[ "$REMOTE_URL" == https://* ]]; then
            REPO_PATH=$(echo "$REMOTE_URL" | sed 's|https://[^/]*/||')
            GITHUB_HOST=$(echo "$REMOTE_URL" | sed 's|https://||' | sed 's|/.*||')
            git remote set-url origin "https://x-access-token:${GH_TOKEN}@${GITHUB_HOST}/${REPO_PATH}"
          fi
          
          git push -u origin "${{ env.BRANCH_NAME }}"
          echo "‚úÖ Branch pushed successfully"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: üì¨ Create Pull Request
        id: create-pr
        run: |
          # Check if copilot-summary.md exists
          if [ -f "copilot-summary.md" ]; then
            PR_BODY=$(cat copilot-summary.md)
          else
            PR_BODY="## ü§ñ Automated Implementation
          
          This PR was automatically generated by GitHub Copilot CLI.
          
          ### üìã Related Issue
          Closes #${ISSUE_NUMBER}
          
          ### üìù Changes
          Please review the changes made by Copilot CLI."
          fi
          
          # Save PR body to file to avoid injection
          printf '%s' "${PR_BODY}" > /tmp/pr_body.txt
          
          # Create PR and capture URL - use file for body
          PR_URL=$(gh pr create \
            --title "${ISSUE_TITLE}" \
            --body-file /tmp/pr_body.txt \
            --base main \
            --head "${BRANCH_NAME}" \
            --assignee "${ISSUE_CREATOR}")
          
          # Clean up
          rm -f /tmp/pr_body.txt
          
          echo "PR_URL=${PR_URL}" >> $GITHUB_ENV
          echo "‚úÖ Pull Request created: ${PR_URL}"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_CREATOR: ${{ github.event.issue.user.login }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
      
      - name: üí¨ Add Completion Comment to Issue
        run: |
          echo "üí¨ Adding completion comment to issue #${ISSUE_NUMBER}..."
          
          COMMENT="## üéâ Implementation Complete!

          The GitHub Copilot CLI has successfully implemented the changes for this issue.

          ### üì¨ Pull Request
          A Pull Request has been created with the implementation:
          ${PR_URL}

          ### üëÄ Next Steps
          1. Review the Pull Request
          2. Test the implementation
          3. Approve and merge if everything looks good

          ### üì¶ Logs
          Workflow logs and Copilot execution logs are available in the workflow run artifacts.

          ---
          *This comment was automatically generated by the GitHub Copilot Coder workflow.*"
          
          gh issue comment "${ISSUE_NUMBER}" --body "${COMMENT}"
          echo "‚úÖ Comment added successfully"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_URL: ${{ env.PR_URL }}
      
      - name: üè∑Ô∏è Update Issue Labels - Completed
        run: |
          gh issue edit ${{ env.ISSUE_NUMBER }} \
            --add-label "ready-for-review" \
            --remove-label "in-progress"
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: üì¶ Publish Logs
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: copilot-logs
          path: logs/
          retention-days: 30
