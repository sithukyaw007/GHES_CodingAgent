name: ü§ñ Copilot PR Reviewer (Master)

# This is a reusable workflow that can be called from other repositories.
# It contains the full implementation logic for the Copilot PR Reviewer.
#
# To use this workflow from another repository, create a caller workflow:
#   jobs:
#     review:
#       uses: <org>/GHES_CodingAgent/.github/workflows/copilot-reviewer-master.yml@main
#       secrets: inherit

on:
  # Direct trigger (for this repository) - only on 'copilot' label
  pull_request:
    types: [labeled]
    branches:
      - main
      - develop
      - feature/*
  
  # Reusable workflow trigger (for other repositories)
  workflow_call:
    secrets:
      GH_TOKEN:
        description: 'Classic PAT with repo and workflow scopes'
        required: true
      COPILOT_TOKEN:
        description: 'Token for GitHub Copilot API access'
        required: true
      CONTEXT7_API_KEY:
        description: 'API key for Context7 documentation service'
        required: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  MODEL: claude-haiku-4.5
  COPILOT_VERSION: latest
  ANALYSIS_DIR: ${{ github.workspace }}/pr-analysis
  DIFF_FILE: ${{ github.workspace }}/pr-diff.json

jobs:
  review:
    runs-on: self-hosted
    name: ü§ñ Analyze PR and Generate Review
    # Only run when the 'copilot' label is added
    if: github.event.label.name == 'copilot'
    
    steps:
      - name: üìã Show PR Information
        run: |
          echo "üìã Pull Request Information:"
          echo "  - Repository: ${{ github.repository }}"
          echo "  - PR #: ${{ github.event.pull_request.number }}"
          echo "  - Source Branch: ${{ github.event.pull_request.head.ref }}"
          echo "  - Target Branch: ${{ github.event.pull_request.base.ref }}"
          echo "  - Source Commit: ${{ github.event.pull_request.head.sha }}"
          echo ""
          echo "üìÅ Working directories:"
          echo "  - Analysis Dir: ${{ env.ANALYSIS_DIR }}"
          echo "  - Diff File: ${{ env.DIFF_FILE }}"

      - name: üìÇ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚úÖ Verify Pre-installed Software
        run: |
          echo "üîç Verifying pre-installed software..."
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          # Check Node.js
          if command -v node &> /dev/null; then
            NODE_VERSION=$(node --version)
            NPM_VERSION=$(npm --version)
            echo "‚úÖ Node.js: $NODE_VERSION"
            echo "‚úÖ npm: $NPM_VERSION"
            
            # Verify Node.js major version is 22
            NODE_MAJOR=$(echo $NODE_VERSION | cut -d. -f1 | sed 's/v//')
            if [ "$NODE_MAJOR" != "22" ]; then
              echo "‚ö†Ô∏è  WARNING: Node.js 22.x is recommended, but $NODE_VERSION is installed."
            fi
          else
            echo "‚ùå ERROR: Node.js is not installed!"
            echo "Please run scripts/setup-runner.sh on this runner."
            exit 1
          fi
          
          # Check GitHub Copilot CLI
          if command -v copilot &> /dev/null; then
            COPILOT_VERSION_INSTALLED=$(copilot --version 2>&1 | head -n1)
            echo "‚úÖ Copilot CLI: $COPILOT_VERSION_INSTALLED"
          else
            echo "‚ùå ERROR: GitHub Copilot CLI is not installed!"
            echo "Please run scripts/setup-runner.sh on this runner."
            exit 1
          fi
          
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ All required software is installed and ready!"

      - name: üîç Get PR Differences
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "üåê Get PR Differences using GitHub API"
          echo "======================================="
          
          GHES_HOST=$(echo "${{ github.server_url }}" | sed 's|https://||')
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          OUTPUT_FILE="${{ env.DIFF_FILE }}"
          
          echo "üìã PR Information:"
          echo "  - GHES Host: $GHES_HOST"
          echo "  - Owner: $OWNER"
          echo "  - Repository: $REPO"
          echo "  - PR Number: $PR_NUMBER"
          echo ""
          
          # Determine API base URL
          if [[ "$GHES_HOST" == "github.com" ]]; then
              API_BASE="https://api.github.com"
          else
              API_BASE="https://$GHES_HOST/api/v3"
          fi
          
          echo "üîó API Base URL: $API_BASE"
          
          # Get PR details
          echo "üîç Fetching PR details..."
          PR_URL="$API_BASE/repos/$OWNER/$REPO/pulls/$PR_NUMBER"
          
          PR_RESPONSE=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "$PR_URL")
          
          BASE_REF=$(echo "$PR_RESPONSE" | grep -o '"base":{"label":"[^"]*"' | cut -d'"' -f8 | cut -d: -f2- || echo "unknown")
          HEAD_REF=$(echo "$PR_RESPONSE" | grep -o '"head":{"label":"[^"]*"' | cut -d'"' -f8 | cut -d: -f2- || echo "unknown")
          
          echo "  - Base Branch: $BASE_REF"
          echo "  - Head Branch: $HEAD_REF"
          
          # Get changed files
          echo "üìÑ Fetching changed files..."
          FILES_URL="$API_BASE/repos/$OWNER/$REPO/pulls/$PR_NUMBER/files"
          
          CHANGES_ARRAY=""
          FIRST=true
          FILE_COUNT=0
          
          for PAGE in 1 2 3; do
              FILES_RESPONSE=$(curl -s \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "$FILES_URL?page=$PAGE&per_page=100")
              
              if echo "$FILES_RESPONSE" | grep -q "^\\[\\]"; then
                  break
              fi
              
              FILENAMES=$(echo "$FILES_RESPONSE" | grep -o '"filename":"[^"]*"' | cut -d'"' -f4)
              
              while IFS= read -r filename; do
                  if [ -n "$filename" ]; then
                      if [ "$FIRST" = false ]; then
                          CHANGES_ARRAY="$CHANGES_ARRAY,"
                      fi
                      CHANGES_ARRAY="$CHANGES_ARRAY
              { \"path\": \"$filename\", \"type\": \"modify\" }"
                      FIRST=false
                      FILE_COUNT=$((FILE_COUNT + 1))
                      echo "   - $filename"
                  fi
              done <<< "$FILENAMES"
          done
          
          echo "‚úÖ Found $FILE_COUNT changed files"
          
          # Create output JSON
          cat > "$OUTPUT_FILE" << EOF
          {
            "pr_number": $PR_NUMBER,
            "base_ref": "$BASE_REF",
            "head_ref": "$HEAD_REF",
            "changes": [$CHANGES_ARRAY
            ],
            "statistics": { "total_changes": $FILE_COUNT }
          }
          EOF
          
          echo "‚úÖ Diff file created: $OUTPUT_FILE"

      - name: üìÅ Download Modified Files
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "üìÅ Downloading Modified PR Files"
          echo "================================="
          
          GHES_HOST=$(echo "${{ github.server_url }}" | sed 's|https://||')
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          OUTPUT_DIR="${{ env.ANALYSIS_DIR }}"
          
          # Determine API base URL
          if [[ "$GHES_HOST" == "github.com" ]]; then
              API_BASE="https://api.github.com"
          else
              API_BASE="https://$GHES_HOST/api/v3"
          fi
          
          # Create output directories
          mkdir -p "$OUTPUT_DIR/source"
          mkdir -p "$OUTPUT_DIR/target"
          mkdir -p "$OUTPUT_DIR/metadata"
          
          # Get files from the PR
          echo "üìÑ Fetching changed files from PR..."
          FILES_URL="$API_BASE/repos/$OWNER/$REPO/pulls/$PR_NUMBER/files"
          
          PAGE=1
          while [ $PAGE -le 10 ]; do
              RESPONSE=$(curl -s \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "$FILES_URL?page=$PAGE&per_page=100")
              
              if echo "$RESPONSE" | grep -q "^\\[\\]"; then
                  break
              fi
              
              echo "$RESPONSE" | jq -r '.[] | .filename' 2>/dev/null >> "/tmp/pr_files_$$.txt" || true
              PAGE=$((PAGE + 1))
          done
          
          if [ ! -f "/tmp/pr_files_$$.txt" ]; then
              echo "‚ö†Ô∏è  No modified files found in PR"
              exit 0
          fi
          
          TOTAL_FILES=$(wc -l < "/tmp/pr_files_$$.txt" | tr -d ' ')
          echo "‚úÖ Found $TOTAL_FILES files to download"
          
          # Get PR details for SHA references
          PR_URL="$API_BASE/repos/$OWNER/$REPO/pulls/$PR_NUMBER"
          PR_DATA=$(curl -s \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "$PR_URL")
          
          HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha // empty')
          BASE_SHA=$(echo "$PR_DATA" | jq -r '.base.sha // empty')
          
          SUCCESSFUL=0
          FAILED=0
          
          while IFS= read -r filepath; do
              if [ -n "$filepath" ]; then
                  echo "üì• Downloading: $filepath"
                  
                  # Create directory structure
                  mkdir -p "$OUTPUT_DIR/source/$(dirname "$filepath")"
                  
                  # Download from source (head) branch
                  CONTENT_URL="$API_BASE/repos/$OWNER/$REPO/contents/$filepath?ref=$HEAD_SHA"
                  curl -s \
                      -H "Authorization: Bearer $GH_TOKEN" \
                      -H "Accept: application/vnd.github.v3.raw" \
                      "$CONTENT_URL" > "$OUTPUT_DIR/source/$filepath" 2>/dev/null
                  
                  if [ -s "$OUTPUT_DIR/source/$filepath" ]; then
                      echo "  ‚úÖ Downloaded"
                      SUCCESSFUL=$((SUCCESSFUL + 1))
                  else
                      echo "  ‚ö†Ô∏è  Could not download"
                      FAILED=$((FAILED + 1))
                  fi
              fi
          done < "/tmp/pr_files_$$.txt"
          
          rm -f "/tmp/pr_files_$$.txt"
          
          echo ""
          echo "üìä Download Summary:"
          echo "  - Total files: $TOTAL_FILES"
          echo "  - Successful: $SUCCESSFUL"
          echo "  - Failed: $FAILED"

      - name: ü§ñ Analyze with GitHub Copilot CLI
        env:
          MODEL: ${{ env.MODEL }}
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN }}
        run: |
          echo "ü§ñ PR Analysis with GitHub Copilot CLI"
          echo "======================================="
          
          PR_DIRECTORY="${{ env.ANALYSIS_DIR }}/source"
          OUTPUT_COMMENTS_DIR="${{ env.ANALYSIS_DIR }}/source/pr-comments"
          
          if [ ! -d "$PR_DIRECTORY" ]; then
              echo "‚ùå ERROR: Directory $PR_DIRECTORY does not exist"
              exit 1
          fi
          
          mkdir -p "$OUTPUT_COMMENTS_DIR"
          
          # Get list of files to analyze
          echo "üîç Scanning files in directory..."
          cd "$PR_DIRECTORY"
          FILES=($(find . -type f ! -path "*/pr-comments/*" ! -name "pr-comment*.md" ! -name ".*" | sed 's|^\./||'))
          
          if [ ${#FILES[@]} -eq 0 ]; then
              echo "‚ö†Ô∏è  No files found to analyze"
              exit 0
          fi
          
          echo "‚úÖ Found ${#FILES[@]} files to analyze:"
          for file in "${FILES[@]}"; do
              echo "   - $file"
          done
          
          # Build the list of files for the prompt
          FILES_LIST=""
          for file in "${FILES[@]}"; do
              FILES_LIST="${FILES_LIST}- \`$file\`"$'\n'
          done
          
          # Create the analysis prompt
          ANALYSIS_PROMPT="Analyze ALL the files in this Pull Request directory and generate a SEPARATE markdown file for EACH file analyzed.

          üìÅ **Files to analyze:**
          $FILES_LIST

          üéØ **IMPORTANT INSTRUCTIONS:**

          For EACH file listed above, you must:
          1. Analyze the file thoroughly
          2. Create a separate markdown file with the analysis if there is anything noteworthy (issues, recommendations)
          3. Name each file following this pattern: replace \`/\` with \`_\` in the original path and add \`_analysis.md\` suffix
          4. Save each file in the directory: \`$OUTPUT_COMMENTS_DIR/\`

          üìù **Format for EACH analysis file:**

          # üî¨ \$relative_path analysis

          ## üìä Overview
          Brief description of what this file does.

          ## ‚ö†Ô∏è Issues and Recommendations
          List issues with type, description, code snippet, and recommendation.

          ## ‚úÖ Summary
          - **Overall Status:** ‚ö†Ô∏è Needs Attention / üî¥ Critical Issues / ‚úÖ Good
          - **Priority:** High/Medium/Low
          - **Action Required:** Yes/No

          Focus only on this single file. Be thorough but concise."

          # Execute copilot for analysis
          echo "ü§ñ Generating analysis with Copilot..."
          copilot -p "$ANALYSIS_PROMPT" --allow-all-tools --model "$MODEL" 2>&1 || true
          
          echo "‚úÖ Copilot analysis completed"
          
          # Summary
          ANALYSIS_COUNT=$(ls -1 "$OUTPUT_COMMENTS_DIR"/*_analysis.md 2>/dev/null | wc -l || echo "0")
          echo "üìä Analysis files generated: $ANALYSIS_COUNT"

      - name: üí¨ Publish Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        if: always()
        run: |
          echo "üí¨ Posting PR Review Comments"
          echo "=============================="
          
          GHES_HOST=$(echo "${{ github.server_url }}" | sed 's|https://||')
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          COMMENTS_DIR="${{ env.ANALYSIS_DIR }}/source/pr-comments"
          
          # Determine API base URL
          if [[ "$GHES_HOST" == "github.com" ]]; then
              API_BASE="https://api.github.com"
          else
              API_BASE="https://$GHES_HOST/api/v3"
          fi
          
          # Verify comments directory exists
          if [ ! -d "$COMMENTS_DIR" ]; then
              echo "‚ö†Ô∏è  No comments directory found"
              exit 0
          fi
          
          # Get list of markdown files
          COMMENT_FILES=($(find "$COMMENTS_DIR" -type f -name "*_analysis.md" 2>/dev/null | sort))
          
          if [ ${#COMMENT_FILES[@]} -eq 0 ]; then
              echo "‚ö†Ô∏è  No analysis files found (this is normal if no issues were found)"
              exit 0
          fi
          
          echo "üìÑ Found ${#COMMENT_FILES[@]} comment files to post"
          
          SUCCESSFUL=0
          FAILED=0
          
          for comment_file in "${COMMENT_FILES[@]}"; do
              filename=$(basename "$comment_file")
              echo "üì§ Posting: $filename"
              
              # Read and escape content
              COMMENT_CONTENT=$(cat "$comment_file")
              ESCAPED_CONTENT=$(printf '%s' "$COMMENT_CONTENT" | \
                  sed 's/\\/\\\\/g' | \
                  sed 's/"/\\"/g' | \
                  sed ':a;N;$!ba;s/\n/\\n/g')
              
              # Create payload
              PAYLOAD="{\"body\": \"$ESCAPED_CONTENT\", \"event\": \"COMMENT\"}"
              
              # Post as a pull request review
              REVIEW_URL="$API_BASE/repos/$OWNER/$REPO/pulls/$PR_NUMBER/reviews"
              
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                  -X POST \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  -H "Content-Type: application/json" \
                  -d "$PAYLOAD" \
                  "$REVIEW_URL")
              
              if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
                  echo "  ‚úÖ Posted successfully"
                  SUCCESSFUL=$((SUCCESSFUL + 1))
              else
                  echo "  ‚ùå Failed (HTTP $HTTP_CODE)"
                  FAILED=$((FAILED + 1))
              fi
              
              sleep 1
          done
          
          echo ""
          echo "üìä Posting Summary:"
          echo "  - Total: ${#COMMENT_FILES[@]}"
          echo "  - Successful: $SUCCESSFUL"
          echo "  - Failed: $FAILED"

      - name: üì¶ Upload Analysis Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pr-analysis-${{ github.event.pull_request.number }}
          path: ${{ env.ANALYSIS_DIR }}/
          retention-days: 30
          if-no-files-found: warn

      - name: üìä Summary
        if: always()
        run: |
          echo "## üìä PR Review Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR Details:**" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- PR #: ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Author: ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "${{ env.ANALYSIS_DIR }}/source/pr-comments" ]; then
            COMMENT_COUNT=$(find "${{ env.ANALYSIS_DIR }}/source/pr-comments" -name "*_analysis.md" 2>/dev/null | wc -l)
            echo "**Review Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Comments Generated: $COMMENT_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- Model Used: ${{ env.MODEL }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ $COMMENT_COUNT -gt 0 ]; then
              echo "**Issues Found:**" >> $GITHUB_STEP_SUMMARY
              find "${{ env.ANALYSIS_DIR }}/source/pr-comments" -name "*_analysis.md" | sort | while read file; do
                echo "- $(basename "$file" _analysis.md)" >> $GITHUB_STEP_SUMMARY
              done
            else
              echo "‚úÖ No issues found!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "**Review Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Comments Generated: 0" >> $GITHUB_STEP_SUMMARY
            echo "- Model Used: ${{ env.MODEL }}" >> $GITHUB_STEP_SUMMARY
            echo "- Status: ‚úÖ No issues found!" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- Full analysis available in [pr-analysis artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)" >> $GITHUB_STEP_SUMMARY
